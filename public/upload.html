<!doctype html>
<html>
	<head>
		<title>Uploader</title>
		<script src="./js/docx2html.js"></script>
		<style>
			button{width:50px;height:100px;position:absolute;top:50px; border: 0px; outline-style: none;}
			#load{
				border-radius:50px 0 0 50px;
				background-color: lightgreen;
				box-shadow: -1px 1px 4px 0.5px rgba(0,0,0,0.2);
				right:100px;
			}
			#save {
				border-radius:0 50px 50px 0;
				right:50px;
				box-shadow: 1px 1px 4px 0.5px rgba(0,0,0,0.2);
				background-color: lightgreen;
			}
			.doing {
				
			}
		</style>
		<script>
			window.parsed=null
			function $Id(id){
				return document.getElementById(id)
			}
			function ajax(data,headers,method,url){
				headers=headers||{};
				method=method||'post';
				url=url||'/';
				var x = new XMLHttpRequest(), p=new $.Deferred();
				x.onreadystatechange=function(e){
					switch(x.readyState){
					case 1:
						Object.keys(headers).forEach(function(k){x.setRequestHeader(k,headers[k])})	
						break
					case 4:
						switch(x.status){
						case 200:
							p.resolve(x.getResponseHeader('content-type').indexOf('json')!=-1 ? JSON.parse(x.responseText) : x.responseText)
							break
						default:
							p.reject(new Error(x.responseText))
						}
					default:
					}
				}
				x.open(method,url, true)
				x.send(data)
				return p;
			}
			
			function getUploadedImages(){
				if(window.uploadedImages)
					return $.Deferred.as(window.uploadedImages)
				return ajax(null,{},'get','/uploadedImages')
					.then(function(data){
						data.forEach(function(a){
							this[a.crc32]=a.url
						},window.uploadedImages={})
						return window.uploadedImages
					})
			}
			
			function save(){
				$Id('save').classList.add('doing');
				parsed.save({
					extendScript:'/js/extend.js',
					saveImage:function(data, docProps){
						return getUploadedImages()
						.then(function(uploadedImages){
							if(uploadedImages[data.crc32])
								return uploadedImages[data.crc32]
							return ajax(data,{'content-type':'image/jpeg','crc32':data.crc32})
								.then(function(file){
									return window.uploadedImages[data.crc32]=file.url
								})
						})
					},
					saveHtml: function(data, docProps){
						return ajax(JSON.stringify($.extend({content:data},docProps)), {'content-type':'application/json'})
					}
				}).then(
					function(post){
						$Id('save').classList.remove('doing')
						alert('saved')
					},
					function(error){
						$Id('save').classList.remove('doing')
						alert(error)
					})
			}
			
			
			function load(){
				require('docx2html')(this.files[0]).then(function(doc){
					parsed=doc
				}); 
				this.value=''
			}
		</script>
	</head>
	<body>
		<button id="load" onclick="$Id('file').click()">Load</button>
		<button id="save" onclick="save()">Save</button>
		<input type="file" id="file" style="position:absolute;top:-100px" onchange="load.call(this)">
	</body>
</html>